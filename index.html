<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Envelope Budget Manager</title>
<!-- Firebase SDK --> <script
src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script> <script
src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script> <script
src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #0a0a0a;
            color: #ffffff;
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            background: #1a1a1a;
            padding: 30px 20px;
            border-radius: 16px;
            margin-bottom: 30px;
            border: 1px solid #2a2a2a;
        }

        h1 {
            font-size: 32px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .header-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            flex-wrap: wrap;
            gap: 12px;
        }

        .header-right {
            display: flex;
            gap: 8px;
            align-items: center;
            flex-wrap: wrap;
        }

        .dropdown {
            position: relative;
            display: inline-block;
        }

        .dropdown-toggle {
            padding: 8px 16px;
            background: #2a2a2a;
            border: 1px solid #3a3a3a;
            border-radius: 8px;
            color: #ffffff;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s;
        }

        .dropdown-toggle:hover {
            background: #3a3a3a;
        }

        .dropdown-menu {
            display: none;
            position: absolute;
            right: 0;
            top: 100%;
            margin-top: 4px;
            background: #1a1a1a;
            border: 1px solid #3a3a3a;
            border-radius: 8px;
            min-width: 200px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.4);
            z-index: 1000;
        }

        .dropdown-menu.active {
            display: block;
        }

        .dropdown-item {
            padding: 12px 16px;
            color: #ffffff;
            cursor: pointer;
            transition: background 0.2s;
            font-size: 14px;
            border-bottom: 1px solid #2a2a2a;
        }

        .dropdown-item:last-child {
            border-bottom: none;
        }

        .dropdown-item:hover {
            background: #2a2a2a;
        }

        .dropdown-item.danger {
            color: #ef4444;
        }

        .dropdown-item.warning {
            color: #f59e0b;
        }

        .test-mode-alert {
            background: #f59e0b;
            color: #000000;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 16px;
            font-weight: 500;
            display: none;
        }

        .closed-month-alert {
            background: #3b82f6;
            color: #ffffff;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 16px;
            font-weight: 500;
            display: none;
        }

        .month-selector {
            display: flex;
            align-items: center;
            gap: 12px;
            margin: 16px 0;
            flex-wrap: wrap;
        }

        .month-selector button {
            padding: 8px 16px;
            background: #2a2a2a;
            border: 1px solid #3a3a3a;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            color: #ffffff;
            transition: all 0.2s;
        }

        .month-selector button:hover {
            background: #3a3a3a;
        }

        .current-month {
            font-size: 18px;
            font-weight: 600;
            padding: 8px 16px;
            background: #2a2a2a;
            border-radius: 8px;
        }

        .summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        @media (min-width: 1024px) {
            .summary {
                grid-template-columns: repeat(4, 1fr);
            }
        }

        .summary-card {
            background: #2a2a2a;
            padding: 20px;
            border-radius: 12px;
            border: 1px solid #3a3a3a;
        }

        .summary-card h3 {
            font-size: 14px;
            font-weight: 500;
            color: #888888;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .summary-card .amount {
            font-size: 28px;
            font-weight: 600;
        }

        .controls {
            display: flex;
            gap: 12px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        button {
            padding: 12px 24px;
            border: none;
            border-radius: 10px;
            font-size: 15px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-add {
            background: #10b981;
            color: white;
        }

        .btn-add:hover:not(:disabled) {
            background: #059669;
            transform: translateY(-1px);
        }

        .btn-spend {
            background: #ef4444;
            color: white;
        }

        .btn-spend:hover:not(:disabled) {
            background: #dc2626;
            transform: translateY(-1px);
        }

        .btn-secondary {
            background: #2a2a2a;
            color: #ffffff;
            border: 1px solid #3a3a3a;
        }

        .btn-secondary:hover:not(:disabled) {
            background: #3a3a3a;
            transform: translateY(-1px);
        }

        .btn-warning {
            background: #f59e0b;
            color: white;
        }

        .btn-warning:hover:not(:disabled) {
            background: #d97706;
            transform: translateY(-1px);
        }

        .btn-success {
            background: #10b981;
            color: white;
        }

        .btn-success:hover:not(:disabled) {
            background: #059669;
            transform: translateY(-1px);
        }

        .btn-danger {
            background: #ef4444;
            color: white;
        }

        .btn-danger:hover:not(:disabled) {
            background: #dc2626;
            transform: translateY(-1px);
        }

        .btn-small {
            padding: 8px 16px;
            font-size: 13px;
        }

        .envelopes-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .envelope-card {
            background: #1a1a1a;
            border-radius: 16px;
            padding: 24px;
            transition: all 0.3s;
            border: 2px solid #2a2a2a;
        }

        .envelope-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 24px rgba(0,0,0,0.4);
        }

        .envelope-card.savings {
            border-color: #3b82f6;
            background: linear-gradient(135deg, #1e3a8a 0%, #1a1a1a 100%);
        }

        .envelope-card.recurrent {
            border-color: #8b5cf6;
            background: linear-gradient(135deg, #4c1d95 0%, #1a1a1a 100%);
        }

        .envelope-badge {
            display: inline-block;
            padding: 6px 12px;
            font-size: 11px;
            font-weight: 600;
            border-radius: 6px;
            margin-bottom: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .envelope-badge.savings {
            background: #1e40af;
            color: #93c5fd;
        }

        .envelope-badge.recurrent {
            background: #6d28d9;
            color: #c4b5fd;
        }

        .envelope-name {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 16px;
        }

        .envelope-balance {
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .envelope-label {
            font-size: 13px;
            color: #888888;
            margin-bottom: 16px;
        }

        .envelope-stats {
            font-size: 13px;
            color: #888888;
            margin-bottom: 12px;
            padding-top: 12px;
            border-top: 1px solid #2a2a2a;
        }

        .envelope-actions {
            display: flex;
            gap: 8px;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            overflow-y: auto;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: #1a1a1a;
            border-radius: 20px;
            padding: 32px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            margin: 20px;
            border: 1px solid #2a2a2a;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }

        .modal-header h2 {
            font-size: 24px;
            font-weight: 600;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 28px;
            color: #888888;
            cursor: pointer;
            padding: 0;
            width: 32px;
            height: 32px;
        }

        .close-btn:hover {
            color: #ffffff;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 8px;
        }

        input, select, textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #3a3a3a;
            border-radius: 10px;
            font-size: 15px;
            font-family: inherit;
            background: #2a2a2a;
            color: #ffffff;
            transition: all 0.2s;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #0071e3;
        }

        .tabs {
            display: flex;
            gap: 4px;
            background: #1a1a1a;
            padding: 4px;
            border-radius: 12px;
            margin-bottom: 20px;
            border: 1px solid #2a2a2a;
        }

        .tab {
            flex: 1;
            padding: 10px 20px;
            border: none;
            background: transparent;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s;
            color: #888888;
        }

        .tab.active {
            background: #2a2a2a;
            color: #ffffff;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .transaction-list {
            background: #1a1a1a;
            border-radius: 16px;
            padding: 24px;
            border: 1px solid #2a2a2a;
        }

        .transaction-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px;
            border-bottom: 1px solid #2a2a2a;
            transition: background 0.2s;
        }

        .transaction-item:hover {
            background: #2a2a2a;
            border-radius: 8px;
        }

        .transaction-item:last-child {
            border-bottom: none;
        }

        .transaction-info {
            flex: 1;
        }

        .transaction-envelope {
            font-weight: 600;
            margin-bottom: 4px;
        }

        .transaction-description {
            font-size: 14px;
            color: #888888;
            margin-bottom: 4px;
        }

        .transaction-meta {
            font-size: 12px;
            color: #666666;
        }

        .transaction-amount {
            font-size: 20px;
            font-weight: 600;
            text-align: right;
        }

        .transaction-amount.expense {
            color: #ef4444;
        }

        .transaction-amount.income {
            color: #10b981;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #888888;
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 16px;
        }

        .account-card {
            cursor: pointer;
            padding: 14px;
            background: #2a2a2a;
            border-radius: 10px;
            border: 1px solid #3a3a3a;
            transition: all 0.2s;
        }

        .account-card:hover {
            background: #3a3a3a;
            transform: translateY(-2px);
        }

        @media (max-width: 768px) {
            .envelopes-grid {
                grid-template-columns: 1fr;
            }
            .summary {
                grid-template-columns: 1fr 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="header-controls">
                <h1>üí∞ Envelope Budget Manager</h1>
                <div class="header-right">
                    <button class="btn-secondary btn-small" onclick="app.openHowToUse()">‚ùì How to Use</button>
                    <div class="dropdown">
                        <button class="dropdown-toggle" onclick="app.toggleDropdown()">‚öôÔ∏è Settings</button>
                        <div class="dropdown-menu" id="settingsDropdown">
                            <div class="dropdown-item warning" onclick="app.toggleTestMode()">
                                <span id="testModeText">üß™ Enable Test Mode</span>
                            </div>
                            <div class="dropdown-item danger" onclick="app.resetMonth()">
                                üîÑ Reset Current Month
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div id="testModeAlert" class="test-mode-alert">
                üß™ <strong>TEST MODE ACTIVE</strong> - All changes are temporary
            </div>
            
            <div id="closedMonthAlert" class="closed-month-alert">
                üîí <strong>MONTH CLOSED</strong> - Click "üîì Reopen Month" to make changes
            </div>
            
            <div class="month-selector">
                <button onclick="app.previousMonth()">‚Üê Previous</button>
                <div class="current-month" id="currentMonthDisplay">December 2024</div>
                <button onclick="app.nextMonth()">Next ‚Üí</button>
                <button onclick="app.goToCurrentMonth()">Today</button>
            </div>
            
            <div class="summary">
                <div class="summary-card">
                    <h3>Recurrent Allocated</h3>
                    <div class="amount" id="recurrentAllocated">MVR 0.00</div>
                </div>
                <div class="summary-card">
                    <h3>Recurrent Spent</h3>
                    <div class="amount" id="recurrentSpent">MVR 0.00</div>
                </div>
                <div class="summary-card">
                    <h3>Recurrent Underspend</h3>
                    <div class="amount" id="recurrentUnderspend" style="color: #10b981;">MVR 0.00</div>
                </div>
                <div class="summary-card">
                    <h3>Savings Added</h3>
                    <div class="amount" id="savingsAdded" style="color: #3b82f6;">MVR 0.00</div>
                </div>
            </div>
            
            <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #2a2a2a;">
                <h3 style="font-size: 16px; font-weight: 600; margin-bottom: 12px;">Account Balances</h3>
                <div id="accountBalances" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 12px;"></div>
            </div>
        </header>

        <div class="controls">
            <button class="btn-add" onclick="app.openAddMoney()" id="addMoneyBtn">+ Add Money</button>
            <button class="btn-spend" onclick="app.openRecordExpense()" id="recordExpenseBtn">- Record Expense</button>
            <button class="btn-secondary" onclick="app.openTransfer()" id="transferBtn">‚ÜîÔ∏è Transfer</button>
            <button class="btn-secondary" onclick="app.openManageEnvelopes()">üìÅ Manage Envelopes</button>
            <button class="btn-secondary" onclick="app.openManageAccounts()">üè¶ Manage Accounts</button>
            <button class="btn-warning" onclick="app.openCloseMonth()" id="closeMonthBtn">üìÖ Close Month</button>
            <button class="btn-secondary" onclick="app.openComparison()">üìä Compare Months</button>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="app.switchTab('envelopes')">Envelopes</button>
            <button class="tab" onclick="app.switchTab('transactions')">Transactions</button>
        </div>

        <div id="envelopesTab" class="tab-content active">
            <div class="envelopes-grid" id="envelopesGrid"></div>
        </div>

        <div id="transactionsTab" class="tab-content">
            <div class="transaction-list">
                <h2 style="margin-bottom: 20px;">Transaction History</h2>
                <div id="transactionsList"></div>
            </div>
        </div>
    </div>

    <!-- Modals (keeping them compact) -->
    
    <!-- Add Money Modal -->
    <div id="addMoneyModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Add Money</h2>
                <button class="close-btn" onclick="app.closeModal('addMoneyModal')">&times;</button>
            </div>
            <form id="addMoneyForm">
                <div class="form-group">
                    <label>Envelope</label>
                    <select id="addEnvelope" required></select>
                </div>
                <div class="form-group">
                    <label>Amount (MVR)</label>
                    <input type="number" id="addAmount" step="0.01" min="0.01" required>
                </div>
                <div class="form-group">
                    <label>Description (optional)</label>
                    <input type="text" id="addDescription" placeholder="e.g., Salary">
                </div>
                <div class="form-group">
                    <label>Who's adding?</label>
                    <select id="addPerson" required>
                        <option value="You">You</option>
                        <option value="Aisha">Aisha</option>
                    </select>
                </div>
                <button type="submit" class="btn-success" style="width: 100%;">Add Money</button>
            </form>
        </div>
    </div>

    <!-- Expense Modal -->
    <div id="expenseModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Record Expense</h2>
                <button class="close-btn" onclick="app.closeModal('expenseModal')">&times;</button>
            </div>
            <form id="expenseForm">
                <div class="form-group">
                    <label>Envelope</label>
                    <select id="expenseEnvelope" required></select>
                </div>
                <div class="form-group">
                    <label>Amount (MVR)</label>
                    <input type="number" id="expenseAmount" step="0.01" min="0.01" required>
                </div>
                <div class="form-group">
                    <label>Description</label>
                    <input type="text" id="expenseDescription" placeholder="e.g., Grocery shopping" required>
                </div>
                <div class="form-group">
                    <label>Who spent?</label>
                    <select id="expensePerson" required>
                        <option value="You">You</option>
                        <option value="Aisha">Aisha</option>
                    </select>
                </div>
                <button type="submit" class="btn-danger" style="width: 100%;">Record Expense</button>
            </form>
        </div>
    </div>

    <!-- Transfer Modal -->
    <div id="transferModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Transfer Money</h2>
                <button class="close-btn" onclick="app.closeModal('transferModal')">&times;</button>
            </div>
            <form id="transferForm">
                <div class="form-group">
                    <label>From Envelope</label>
                    <select id="transferFrom" required></select>
                </div>
                <div class="form-group">
                    <label>To Envelope</label>
                    <select id="transferTo" required></select>
                </div>
                <div class="form-group">
                    <label>Amount (MVR)</label>
                    <input type="number" id="transferAmount" step="0.01" min="0.01" required>
                </div>
                <div class="form-group">
                    <label>Note (optional)</label>
                    <input type="text" id="transferNote" placeholder="e.g., Rebalancing">
                </div>
                <div class="form-group">
                    <label>Who's transferring?</label>
                    <select id="transferPerson" required>
                        <option value="You">You</option>
                        <option value="Aisha">Aisha</option>
                    </select>
                </div>
                <button type="submit" class="btn-success" style="width: 100%;">Transfer Money</button>
            </form>
        </div>
    </div>

    <!-- Manage Envelopes Modal -->
    <div id="manageEnvelopesModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Manage Envelopes</h2>
                <button class="close-btn" onclick="app.closeModal('manageEnvelopesModal')">&times;</button>
            </div>
            <button class="btn-success" style="width: 100%; margin-bottom: 20px;" onclick="app.openAddEnvelope()">+ Add New Envelope</button>
            <div id="envelopesList"></div>
        </div>
    </div>

    <!-- Add Envelope Modal -->
    <div id="addEnvelopeModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Add New Envelope</h2>
                <button class="close-btn" onclick="app.closeModal('addEnvelopeModal')">&times;</button>
            </div>
            <form id="addEnvelopeForm">
                <div class="form-group">
                    <label>Envelope Name</label>
                    <input type="text" id="newEnvelopeName" placeholder="e.g., Entertainment" required>
                </div>
                <div class="form-group">
                    <label>Type</label>
                    <select id="newEnvelopeType" required>
                        <option value="recurrent">Recurrent Expenditure</option>
                        <option value="savings">Savings</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Account</label>
                    <select id="newEnvelopeAccount" required></select>
                </div>
                <button type="submit" class="btn-success" style="width: 100%;">Create Envelope</button>
            </form>
        </div>
    </div>

    <!-- Manage Accounts Modal -->
    <div id="manageAccountsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Manage Accounts</h2>
                <button class="close-btn" onclick="app.closeModal('manageAccountsModal')">&times;</button>
            </div>
            <button class="btn-success" style="width: 100%; margin-bottom: 20px;" onclick="app.openAddAccount()">+ Add New Account</button>
            <div id="accountsList"></div>
        </div>
    </div>

    <!-- Add Account Modal -->
    <div id="addAccountModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Add New Account</h2>
                <button class="close-btn" onclick="app.closeModal('addAccountModal')">&times;</button>
            </div>
            <form id="addAccountForm">
                <div class="form-group">
                    <label>Account Name</label>
                    <input type="text" id="newAccountName" placeholder="e.g., Savings Account" required>
                </div>
                <button type="submit" class="btn-success" style="width: 100%;">Create Account</button>
            </form>
        </div>
    </div>

    <!-- Envelope Detail Modal -->
    <div id="envelopeDetailModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="detailEnvelopeName"></h2>
                <button class="close-btn" onclick="app.closeModal('envelopeDetailModal')">&times;</button>
            </div>
            <div id="envelopeDetailContent"></div>
        </div>
    </div>

    <!-- Account Transactions Modal -->
    <div id="accountTransactionsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="accountTransactionsName"></h2>
                <button class="close-btn" onclick="app.closeModal('accountTransactionsModal')">&times;</button>
            </div>
            <div id="accountTransactionsContent"></div>
        </div>
    </div>

    <!-- Close Month Modal -->
    <div id="closeMonthModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Close Month</h2>
                <button class="close-btn" onclick="app.closeModal('closeMonthModal')">&times;</button>
            </div>
            <div id="closeMonthContent"></div>
        </div>
    </div>

    <!-- Comparison Modal -->
    <div id="comparisonModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Month Comparison</h2>
                <button class="close-btn" onclick="app.closeModal('comparisonModal')">&times;</button>
            </div>
            <div id="comparisonContent"></div>
        </div>
    </div>

    <!-- How to Use Modal -->
    <div id="howToUseModal" class="modal">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <h2>üìñ How to Use</h2>
                <button class="close-btn" onclick="app.closeModal('howToUseModal')">&times;</button>
            </div>
            <div style="color: #888888; line-height: 1.8;">
                <h3 style="color: #ffffff; font-size: 20px; margin: 24px 0 12px 0;">üéØ Getting Started</h3>
                <p>The Envelope Method allocates money into "envelopes" for specific purposes. When you spend, money is deducted from that envelope's balance.</p>
                
                <h3 style="color: #ffffff; font-size: 18px; margin: 24px 0 12px 0;">üí∞ How Envelopes Work</h3>
                <p><strong>Example:</strong></p>
                <p style="margin-left: 20px;">‚Ä¢ Add MVR 3,000 to Groceries ‚Üí Balance: <strong>MVR 3,000</strong></p>
                <p style="margin-left: 20px;">‚Ä¢ Spend MVR 500 ‚Üí Balance: <strong>MVR 2,500</strong></p>
                <p style="margin-left: 20px;">‚Ä¢ Spend MVR 800 ‚Üí Balance: <strong>MVR 1,700</strong></p>
                <p style="margin-top: 12px;">The balance shown is <strong>always available money</strong> - what you can spend right now.</p>
                
                <h3 style="color: #ffffff; font-size: 18px; margin: 24px 0 12px 0;">üíé Envelope Types</h3>
                <p><strong style="color: #3b82f6;">üíé Savings</strong> - Accumulates over time (Rainy Day, Holiday, House Capital)</p>
                <p><strong style="color: #8b5cf6;">üîÑ Recurrent</strong> - Monthly spending (Bills, Groceries, Family expenses)</p>
                
                <h3 style="color: #ffffff; font-size: 18px; margin: 24px 0 12px 0;">üìÖ Monthly Workflow</h3>
                <ol style="margin-left: 20px;">
                    <li><strong style="color: #10b981;">+ Add Money</strong> - Put money into envelopes</li>
                    <li><strong style="color: #ef4444;">- Record Expense</strong> - Deduct from envelope balance</li>
                    <li><strong>Dashboard</strong> - See this month's activity and underspend</li>
                    <li><strong>üìÖ Close Month</strong> - Allocate recurrent underspend</li>
                </ol>
                
                <h3 style="color: #ffffff; font-size: 18px; margin: 24px 0 12px 0;">üìä Dashboard Explained</h3>
                <p><strong style="color: #8b5cf6;">Recurrent:</strong> Shows this month's activity</p>
                <p style="margin-left: 20px;">‚Ä¢ <strong>Allocated</strong> - Money added this month</p>
                <p style="margin-left: 20px;">‚Ä¢ <strong>Spent</strong> - Money spent this month</p>
                <p style="margin-left: 20px;">‚Ä¢ <strong>Underspend</strong> - Leftover to allocate at month end</p>
                
                <p style="margin-top: 12px;"><strong style="color: #3b82f6;">Savings:</strong> Shows this month's additions</p>
                <p style="margin-left: 20px;">‚Ä¢ <strong>Added</strong> - Money put into savings this month</p>
                <p style="margin-top: 12px;"><strong style="color: #3b82f6;">Savings:</strong> Shows this month's additions</p>
                <p style="margin-left: 20px;">‚Ä¢ <strong>Added</strong> - Money put into savings this month</p>
                
                <h3 style="color: #ffffff; font-size: 18px; margin: 24px 0 12px 0;">üß™ Test Mode</h3>
                <p>Click <strong>‚öôÔ∏è Settings ‚Üí Enable Test Mode</strong> to explore without affecting real data. Perfect for learning!</p>
                
                <h3 style="color: #ffffff; font-size: 18px; margin: 24px 0 12px 0;">üîí Closed Months</h3>
                <p>Once closed, months are locked. All editing buttons are disabled. Click "üîì Reopen Month" to make changes.</p>
                
                <h3 style="color: #ffffff; font-size: 18px; margin: 24px 0 12px 0;">‚öôÔ∏è Settings Menu</h3>
                <p><strong>Test Mode:</strong> Safe sandbox for testing</p>
                <p><strong>Reset Month:</strong> Clear all data for current month (use carefully!)</p>
            </div>
        </div>
    </div>

    <script>
        const app = {
            // Core state
            envelopeDefinitions: [
                { name: 'Bills (Gym + Phone)', account: 'Imma Savings', type: 'recurrent' },
                { name: 'Family', account: 'Imma Savings', type: 'recurrent' },
                { name: 'Imma care', account: 'Imma Savings', type: 'recurrent' },
                { name: 'Aisha care', account: 'A BML Savings', type: 'recurrent' },
                { name: 'Cat recurrent', account: 'Joint Savings', type: 'recurrent' },
                { name: 'Misc', account: 'Joint Savings', type: 'recurrent' },
                { name: 'Groceries', account: 'Imma Savings', type: 'recurrent' },
                { name: 'Rainy Day', account: 'A MIB Savings', type: 'savings' },
                { name: 'House Capital', account: 'A BML Savings', type: 'savings' },
                { name: 'Cat Capital', account: 'A BML Savings', type: 'savings' },
                { name: 'Holiday', account: 'A BML Savings', type: 'savings' },
                { name: 'Investments', account: 'A BML Savings', type: 'savings' }
            ],
            
            accounts: ['Joint Current', 'Joint Savings', 'Imma Savings', 'A BML Savings', 'A MIB Savings'],
            
            allTransactions: [],
            monthlyData: {},
            currentViewMonth: new Date(),
            
            isTestMode: false,
            testBackup: null,

            // Firebase Configuration
            firebaseConfig: {
                apiKey: "AIzaSyAGILbPJtrPKowDUZ_bbVs2VIubv9MiL68",
                authDomain: "imma-aisha-budget.firebaseapp.com",
                databaseURL: "https://imma-aisha-budget-default-rtdb.asia-southeast1.firebasedatabase.app",
                projectId: "imma-aisha-budget",
                storageBucket: "imma-aisha-budget.firebasestorage.app",
                messagingSenderId: "411684264296",
                appId: "1:411684264296:web:f1effd311a4fb49d489edd"
            },

            initFirebase() {
                firebase.initializeApp(this.firebaseConfig);
                this.database = firebase.database();
                this.auth = firebase.auth();
                
                this.database.ref('budgetData').on('value', (snapshot) => {
                    if (this.isTestMode) return;
                    
                    const data = snapshot.val();
                    if (data && this.auth.currentUser) {
                        this.envelopeDefinitions = data.envelopeDefinitions || this.envelopeDefinitions;
                        this.accounts = data.accounts || this.accounts;
                        this.allTransactions = data.allTransactions || [];
                        this.monthlyData = data.monthlyData || {};
                        this.render();
                    }
                });
            },

            initAuth() {
                return new Promise((resolve) => {
                    this.auth.onAuthStateChanged((user) => {
                        if (user) {
                            console.log('‚úÖ Logged in as:', user.email);
                            resolve(true);
                        } else {
                            this.showLoginPrompt();
                            resolve(false);
                        }
                    });
                });
            },

            showLoginPrompt() {
                const email = prompt('Enter your email:');
                const password = prompt('Enter your password:');
                
                if (email && password) {
                    this.auth.signInWithEmailAndPassword(email, password)
                        .then(() => {
                            alert('‚úÖ Login successful!');
                            location.reload();
                        })
                        .catch((error) => {
                            alert('‚ùå Login failed: ' + error.message);
                            this.showLoginPrompt();
                        });
                }
            },

            
            // Initialize
            async init() {
                this.initFirebase();
		await this.initAuth();
                this.setupEventListeners();
                this.render();
            },
            
            // Storage - Firebase will replace this
            loadFromStorage() {
                try {
                    const stored = localStorage.getItem('budgetData');
                    if (stored) {
                        const data = JSON.parse(stored);
                        this.envelopeDefinitions = data.envelopeDefinitions || this.envelopeDefinitions;
                        this.accounts = data.accounts || this.accounts;
                        this.allTransactions = data.allTransactions || [];
                        this.monthlyData = data.monthlyData || {};
                    }
                } catch (e) {
                    console.error('Load error:', e);
                }
            },
            
            saveToStorage() {
                if (this.isTestMode) return;
                
                try {
                    const data = {
                        envelopeDefinitions: this.envelopeDefinitions,
                        accounts: this.accounts,
                        allTransactions: this.allTransactions,
                        monthlyData: this.monthlyData,
                        version: '2.0',
                        lastUpdated: new Date().toISOString()
                    };
                    
                    // Save to Firebase
                    this.database.ref('budgetData').set(data);
                    console.log('‚úÖ Data synced to Firebase');
                } catch (e) {
                    console.error('‚ùå Sync error:', e);
                    alert('Failed to sync! Check internet connection.');
                }
            },
            
            // Firebase ready - just replace loadFromStorage and saveToStorage with:
            /*
            initFirebase() {
                const firebaseConfig = {
                    // Your config here
                };
                firebase.initializeApp(firebaseConfig);
                this.database = firebase.database();
                
                this.database.ref('budgetData').on('value', (snapshot) => {
                    if (this.isTestMode) return;
                    const data = snapshot.val();
                    if (data) {
                        this.envelopeDefinitions = data.envelopeDefinitions || this.envelopeDefinitions;
                        this.accounts = data.accounts || this.accounts;
                        this.allTransactions = data.allTransactions || [];
                        this.monthlyData = data.monthlyData || {};
                        this.render();
                    }
                });
            },
            
            saveToStorage() {
                if (this.isTestMode) return;
                this.database.ref('budgetData').set({
                    envelopeDefinitions: this.envelopeDefinitions,
                    accounts: this.accounts,
                    allTransactions: this.allTransactions,
                    monthlyData: this.monthlyData,
                    version: '2.0',
                    lastUpdated: new Date().toISOString()
                });
            }
            */
            
            getMonthKey(date = this.currentViewMonth) {
                return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
            },
            
            getMonthTransactions(monthKey = this.getMonthKey()) {
                return this.allTransactions.filter(t => {
                    const tDate = new Date(t.date);
                    return this.getMonthKey(tDate) === monthKey;
                });
            },
            
            isMonthClosed(monthKey = this.getMonthKey()) {
                return this.monthlyData[monthKey]?.closed || false;
            },
            
            getEnvelopeBalances() {
                // Calculate envelope balances from ALL transactions (cumulative)
                const balances = {};
                this.envelopeDefinitions.forEach(env => {
                    balances[env.name] = 0;
                });
                
                // Process ALL transactions to get current balances
                this.allTransactions.forEach(t => {
                    if (t.type === 'income' && t.envelope) {
                        balances[t.envelope] = (balances[t.envelope] || 0) + t.amount;
                    } else if (t.type === 'expense' && t.envelope) {
                        balances[t.envelope] = (balances[t.envelope] || 0) - t.amount;
                    } else if (t.type === 'transfer') {
                        balances[t.fromEnvelope] = (balances[t.fromEnvelope] || 0) - t.amount;
                        balances[t.toEnvelope] = (balances[t.toEnvelope] || 0) + t.amount;
                    }
                });
                
                return balances;
            },
            
            getAccountBalances() {
                const accountBalances = {};
                this.accounts.forEach(acc => accountBalances[acc] = 0);
                
                this.allTransactions.forEach(t => {
                    const getEnvAccount = (envName) => {
                        const env = this.envelopeDefinitions.find(e => e.name === envName);
                        return env ? env.account : null;
                    };
                    
                    if (t.type === 'income' && t.envelope) {
                        const account = getEnvAccount(t.envelope);
                        if (account) accountBalances[account] += t.amount;
                    } else if (t.type === 'expense' && t.envelope) {
                        const account = getEnvAccount(t.envelope);
                        if (account) accountBalances[account] -= t.amount;
                    } else if (t.type === 'transfer') {
                        const fromAccount = getEnvAccount(t.fromEnvelope);
                        const toAccount = getEnvAccount(t.toEnvelope);
                        
                        if (fromAccount !== toAccount) {
                            if (fromAccount) accountBalances[fromAccount] -= t.amount;
                            if (toAccount) accountBalances[toAccount] += t.amount;
                        }
                    }
                });
                
                return accountBalances;
            },
            
            render() {
                this.renderMonthDisplay();
                this.renderSummary();
                this.renderEnvelopes();
                this.renderAccountBalances();
                this.renderTransactions();
                this.updateUIState();
                this.populateDropdowns();
            },
            
            renderMonthDisplay() {
                const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 
                                  'July', 'August', 'September', 'October', 'November', 'December'];
                const now = new Date();
                const isFuture = this.currentViewMonth > now;
                const displayText = `${monthNames[this.currentViewMonth.getMonth()]} ${this.currentViewMonth.getFullYear()}`;
                
                document.getElementById('currentMonthDisplay').innerHTML = isFuture 
                    ? `${displayText} <span style="font-size: 13px; color: #f59e0b;">(Planning)</span>`
                    : displayText;
            },
            
            renderSummary() {
                const monthKey = this.getMonthKey();
                const monthTransactions = this.getMonthTransactions(monthKey);
                
                const recurrentEnvNames = this.envelopeDefinitions
                    .filter(e => e.type === 'recurrent' || !e.type)
                    .map(e => e.name);
                
                const savingsEnvNames = this.envelopeDefinitions
                    .filter(e => e.type === 'savings')
                    .map(e => e.name);
                
                const recurrentAllocated = monthTransactions
                    .filter(t => t.type === 'income' && recurrentEnvNames.includes(t.envelope))
                    .reduce((sum, t) => sum + t.amount, 0);
                
                const recurrentSpent = monthTransactions
                    .filter(t => t.type === 'expense' && recurrentEnvNames.includes(t.envelope))
                    .reduce((sum, t) => sum + t.amount, 0);
                
                const recurrentUnderspend = recurrentAllocated - recurrentSpent;
                
                const savingsAdded = monthTransactions
                    .filter(t => t.type === 'income' && savingsEnvNames.includes(t.envelope))
                    .reduce((sum, t) => sum + t.amount, 0);
                
                const savingsFromTransfers = monthTransactions
                    .filter(t => t.type === 'transfer' && 
                           savingsEnvNames.includes(t.toEnvelope) && 
                           recurrentEnvNames.includes(t.fromEnvelope))
                    .reduce((sum, t) => sum + t.amount, 0);
                
                const totalSavingsAdded = savingsAdded + savingsFromTransfers;
                
                document.getElementById('recurrentAllocated').textContent = `MVR ${recurrentAllocated.toFixed(2)}`;
                document.getElementById('recurrentSpent').textContent = `MVR ${recurrentSpent.toFixed(2)}`;
                document.getElementById('recurrentUnderspend').textContent = `MVR ${recurrentUnderspend.toFixed(2)}`;
                document.getElementById('savingsAdded').textContent = `MVR ${totalSavingsAdded.toFixed(2)}`;
            },
            
            renderAccountBalances() {
                const accountBalances = this.getAccountBalances();
                const container = document.getElementById('accountBalances');
                
                container.innerHTML = this.accounts.map(acc => `
                    <div class="account-card" onclick="app.viewAccountTransactions('${acc}')">
                        <div style="font-size: 11px; color: #888888; margin-bottom: 4px; text-transform: uppercase; letter-spacing: 0.5px;">${acc}</div>
                        <div style="font-size: 18px; font-weight: 600;">MVR ${accountBalances[acc].toFixed(2)}</div>
                    </div>
                `).join('');
            },
            
            renderTransactions() {
                const monthKey = this.getMonthKey();
                const monthTransactions = this.getMonthTransactions(monthKey).reverse();
                const container = document.getElementById('transactionsList');
                
                if (monthTransactions.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">üì≠</div>
                            <p>No transactions this month</p>
                        </div>
                    `;
                } else {
                    container.innerHTML = monthTransactions.map(t => {
                        const date = new Date(t.date);
                        const dateStr = date.toLocaleDateString('en-US', { 
                            month: 'short', 
                            day: 'numeric',
                            hour: '2-digit',
                            minute: '2-digit'
                        });
                        
                        let envelopeText = '';
                        if (t.type === 'transfer') {
                            envelopeText = `${t.fromEnvelope} ‚Üí ${t.toEnvelope}`;
                        } else {
                            envelopeText = t.envelope;
                        }
                        
                        return `
                            <div class="transaction-item">
                                <div class="transaction-info">
                                    <div class="transaction-envelope">${envelopeText}</div>
                                    <div class="transaction-description">${t.description || ''}</div>
                                    <div class="transaction-meta">${t.person} ‚Ä¢ ${dateStr}</div>
                                </div>
                                <div class="transaction-amount ${t.type}">
                                    ${t.type === 'expense' ? '-' : t.type === 'income' ? '+' : ''}MVR ${t.amount.toFixed(2)}
                                </div>
                            </div>
                        `;
                    }).join('');
                }
            },
            
            renderEnvelopes() {
                const grid = document.getElementById('envelopesGrid');
                const balances = this.getEnvelopeBalances();
                const monthKey = this.getMonthKey();
                const monthTransactions = this.getMonthTransactions(monthKey);
                
                grid.innerHTML = '';
                
                this.envelopeDefinitions.forEach((env, index) => {
                    const balance = balances[env.name] || 0;
                    const envTransactions = monthTransactions.filter(t => 
                        t.envelope === env.name || t.fromEnvelope === env.name || t.toEnvelope === env.name
                    );
                    
                    const allocated = envTransactions
                        .filter(t => t.type === 'income' && t.envelope === env.name)
                        .reduce((sum, t) => sum + t.amount, 0);
                    
                    const spent = envTransactions
                        .filter(t => t.type === 'expense' && t.envelope === env.name)
                        .reduce((sum, t) => sum + t.amount, 0);
                    
                    let statusClass = env.type || 'recurrent';
                    
                    const card = document.createElement('div');
                    card.className = `envelope-card ${statusClass}`;
                    card.innerHTML = `
                        <div class="envelope-badge ${env.type}">${env.type === 'savings' ? 'üíé Savings' : 'üîÑ Recurrent'}</div>
                        <div class="envelope-name">${env.name}</div>
                        <div class="envelope-balance" style="color: ${balance < 0 ? '#ef4444' : '#ffffff'}">
                            MVR ${balance.toFixed(2)}
                        </div>
                        <div class="envelope-label">Available Balance ‚Ä¢ ${env.account}</div>
                        ${env.type === 'recurrent' || !env.type ? `
                            <div class="envelope-stats">
                                <span style="color: #888888;">This month: </span>
                                <span style="color: #10b981;">+${allocated.toFixed(2)}</span>
                                <span style="color: #ef4444;"> -${spent.toFixed(2)}</span>
                            </div>
                        ` : ''}
                        <div class="envelope-actions">
                            <button class="btn-add btn-small" onclick="app.quickAddMoney(${index})" id="envAdd${index}">+ Add</button>
                            <button class="btn-spend btn-small" onclick="app.quickExpense(${index})" id="envSpend${index}">- Spend</button>
                            <button class="btn-secondary btn-small" onclick="app.viewEnvelopeDetail(${index})">Details</button>
                        </div>
                    `;
                    grid.appendChild(card);
                });
            },
            
            updateUIState() {
                const monthKey = this.getMonthKey();
                const isClosed = this.isMonthClosed(monthKey);
                const now = new Date();
                const isPastOrCurrent = this.currentViewMonth <= now;
                
                // Show/hide alerts
                document.getElementById('testModeAlert').style.display = this.isTestMode ? 'block' : 'none';
                document.getElementById('closedMonthAlert').style.display = isClosed ? 'block' : 'none';
                
                // Update test mode button text
                document.getElementById('testModeText').textContent = this.isTestMode ? 'üß™ Disable Test Mode' : 'üß™ Enable Test Mode';
                
                // Update close month button
                const closeBtn = document.getElementById('closeMonthBtn');
                if (isClosed) {
                    closeBtn.textContent = 'üîì Reopen Month';
                    closeBtn.className = 'btn-secondary';
                    closeBtn.style.display = 'block';
                } else if (isPastOrCurrent) {
                    closeBtn.textContent = 'üìÖ Close Month';
                    closeBtn.className = 'btn-warning';
                    closeBtn.style.display = 'block';
                } else {
                    closeBtn.style.display = 'none';
                }
                
                // Disable/enable buttons if month is closed
                const buttonsToDisable = ['addMoneyBtn', 'recordExpenseBtn', 'transferBtn'];
                buttonsToDisable.forEach(id => {
                    const btn = document.getElementById(id);
                    if (btn) btn.disabled = isClosed;
                });
                
                // Disable envelope action buttons
                this.envelopeDefinitions.forEach((env, i) => {
                    const addBtn = document.getElementById(`envAdd${i}`);
                    const spendBtn = document.getElementById(`envSpend${i}`);
                    if (addBtn) addBtn.disabled = isClosed;
                    if (spendBtn) spendBtn.disabled = isClosed;
                });
            },
            
            // Month navigation
            previousMonth() {
                this.currentViewMonth = new Date(
                    this.currentViewMonth.getFullYear(),
                    this.currentViewMonth.getMonth() - 1,
                    1
                );
                this.render();
            },
            
            nextMonth() {
                this.currentViewMonth = new Date(
                    this.currentViewMonth.getFullYear(),
                    this.currentViewMonth.getMonth() + 1,
                    1
                );
                this.render();
            },
            
            goToCurrentMonth() {
                this.currentViewMonth = new Date();
                this.render();
            },
            
            // Settings dropdown
            toggleDropdown() {
                const dropdown = document.getElementById('settingsDropdown');
                dropdown.classList.toggle('active');
            },
            
            // Test mode
            toggleTestMode() {
                this.toggleDropdown();
                
                if (this.isTestMode) {
                    if (confirm('Exit Test Mode? All test changes will be discarded.')) {
                        this.envelopeDefinitions = JSON.parse(JSON.stringify(this.testBackup.envelopeDefinitions));
                        this.accounts = JSON.parse(JSON.stringify(this.testBackup.accounts));
                        this.allTransactions = JSON.parse(JSON.stringify(this.testBackup.allTransactions));
                        this.monthlyData = JSON.parse(JSON.stringify(this.testBackup.monthlyData));
                        
                        this.isTestMode = false;
                        this.render();
                    }
                } else {
                    this.testBackup = {
                        envelopeDefinitions: JSON.parse(JSON.stringify(this.envelopeDefinitions)),
                        accounts: JSON.parse(JSON.stringify(this.accounts)),
                        allTransactions: JSON.parse(JSON.stringify(this.allTransactions)),
                        monthlyData: JSON.parse(JSON.stringify(this.monthlyData))
                    };
                    
                    this.isTestMode = true;
                    this.render();
                }
            },
            
            // Reset month
            resetMonth() {
                this.toggleDropdown();
                
                const monthKey = this.getMonthKey();
                const isClosed = this.isMonthClosed(monthKey);
                
                if (isClosed) {
                    alert('Cannot reset a closed month! Please reopen it first.');
                    return;
                }
                
                const monthName = document.getElementById('currentMonthDisplay').textContent;
                
                if (!confirm(`‚ö†Ô∏è RESET ${monthName}?\n\nThis will DELETE all allocations and spending for this month.\n\nAccount balances will remain correct.\n\nThis cannot be undone!`)) {
                    return;
                }
                
                this.allTransactions = this.allTransactions.filter(t => {
                    const tDate = new Date(t.date);
                    return this.getMonthKey(tDate) !== monthKey;
                });
                
                if (this.monthlyData[monthKey]) {
                    this.monthlyData[monthKey].closed = false;
                }
                
                this.saveToStorage();
                this.render();
                alert(`‚úÖ ${monthName} has been reset!`);
            },
            
            // Modal helpers
            openModal(id) {
                document.getElementById(id).classList.add('active');
            },
            
            closeModal(id) {
                document.getElementById(id).classList.remove('active');
            },
            
            // Actions
            openAddMoney() {
                if (this.isMonthClosed()) {
                    alert('Month is closed! Reopen it to make changes.');
                    return;
                }
                this.openModal('addMoneyModal');
            },
            
            openRecordExpense() {
                if (this.isMonthClosed()) {
                    alert('Month is closed! Reopen it to make changes.');
                    return;
                }
                this.openModal('expenseModal');
            },
            
            openTransfer() {
                if (this.isMonthClosed()) {
                    alert('Month is closed! Reopen it to make changes.');
                    return;
                }
                this.openModal('transferModal');
            },
            
            openManageEnvelopes() {
                const list = document.getElementById('envelopesList');
                list.innerHTML = this.envelopeDefinitions.map((env, i) => `
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 16px; border-bottom: 1px solid #2a2a2a;">
                        <div style="flex: 1;">
                            <div style="font-weight: 600; margin-bottom: 4px;">${env.name}</div>
                            <div style="font-size: 14px; color: #888888;">${env.account} ‚Ä¢ ${env.type}</div>
                        </div>
                        <div style="display: flex; gap: 8px;">
                            <button class="btn-secondary btn-small" onclick="app.renameEnvelope(${i})">Rename</button>
                            <button class="btn-secondary btn-small" onclick="app.changeEnvelopeType(${i})">Change Type</button>
                            <button class="btn-danger btn-small" onclick="app.deleteEnvelope(${i})">Delete</button>
                        </div>
                    </div>
                `).join('');
                this.openModal('manageEnvelopesModal');
            },
            
            openAddEnvelope() {
                this.closeModal('manageEnvelopesModal');
                this.openModal('addEnvelopeModal');
            },
            
            openManageAccounts() {
                const list = document.getElementById('accountsList');
                const accountBalances = this.getAccountBalances();
                
                list.innerHTML = this.accounts.map((acc, i) => {
                    const envelopesUsingAccount = this.envelopeDefinitions.filter(e => e.account === acc);
                    
                    return `
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 16px; border-bottom: 1px solid #2a2a2a;">
                            <div style="flex: 1;">
                                <div style="font-weight: 600; margin-bottom: 4px;">${acc}</div>
                                <div style="font-size: 14px; color: #888888;">
                                    Balance: MVR ${accountBalances[acc].toFixed(2)} ‚Ä¢ 
                                    ${envelopesUsingAccount.length} envelope(s)
                                </div>
                            </div>
                            <div style="display: flex; gap: 8px;">
                                <button class="btn-secondary btn-small" onclick="app.renameAccount(${i})">Rename</button>
                                <button class="btn-danger btn-small" onclick="app.deleteAccount(${i})" ${envelopesUsingAccount.length > 0 ? 'disabled style="opacity: 0.5;"' : ''}>
                                    Delete
                                </button>
                            </div>
                        </div>
                    `;
                }).join('');
                
                this.openModal('manageAccountsModal');
            },
            
            openAddAccount() {
                this.closeModal('manageAccountsModal');
                this.openModal('addAccountModal');
            },
            
            deleteAccount(index) {
                const account = this.accounts[index];
                const envelopesUsingAccount = this.envelopeDefinitions.filter(e => e.account === account);
                
                if (envelopesUsingAccount.length > 0) {
                    alert(`Cannot delete "${account}"!\n\n${envelopesUsingAccount.length} envelope(s) use this account. Reassign them first.`);
                    return;
                }
                
                if (!confirm(`Delete account "${account}"?`)) {
                    return;
                }
                
                this.accounts.splice(index, 1);
                this.saveToStorage();
                this.render();
                this.openManageAccounts();
            },
            
            openCloseMonth() {
                const monthKey = this.getMonthKey();
                const isClosed = this.isMonthClosed(monthKey);
                
                if (isClosed) {
                    if (confirm('Reopen this month? You\'ll be able to make changes again.')) {
                        this.monthlyData[monthKey].closed = false;
                        this.saveToStorage();
                        this.render();
                    }
                    return;
                }
                
                const monthTransactions = this.getMonthTransactions(monthKey);
                const underspendData = [];
                
                this.envelopeDefinitions.filter(env => env.type === 'recurrent' || !env.type).forEach(env => {
                    const envTx = monthTransactions.filter(t => t.envelope === env.name);
                    const allocated = envTx.filter(t => t.type === 'income').reduce((s, t) => s + t.amount, 0);
                    const spent = envTx.filter(t => t.type === 'expense').reduce((s, t) => s + t.amount, 0);
                    const underspend = allocated - spent;
                    
                    if (underspend > 0) {
                        underspendData.push({ env, allocated, spent, underspend });
                    }
                });
                
                const content = document.getElementById('closeMonthContent');
                
                if (underspendData.length === 0) {
                    content.innerHTML = `
                        <p style="margin-bottom: 20px;">No underspend to allocate. Ready to close?</p>
                        <button class="btn-success" style="width: 100%;" onclick="app.finalizeCloseMonth()">Close Month</button>
                    `;
                } else {
                    this.underspendAllocations = {};
                    this.underspendData = underspendData;
                    
                    content.innerHTML = `
                        <div style="padding: 16px; background: #2a2a2a; border-radius: 12px; margin-bottom: 20px; border: 1px solid #f59e0b;">
                            <p style="margin-bottom: 12px; font-weight: 600;">‚ö†Ô∏è Allocate all underspend before closing</p>
                        </div>
                        ${underspendData.map((data, i) => `
                            <div style="background: #2a2a2a; padding: 16px; border-radius: 12px; margin-bottom: 12px; border: 1px solid #3a3a3a;">
                                <h4>${data.env.name}</h4>
                                <p style="font-size: 14px; color: #888888; margin: 8px 0;">
                                    Allocated: MVR ${data.allocated.toFixed(2)} | 
                                    Spent: MVR ${data.spent.toFixed(2)} | 
                                    Underspend: <strong style="color: #10b981;">MVR ${data.underspend.toFixed(2)}</strong>
                                </p>
                                <div style="display: flex; gap: 8px; margin-top: 12px;">
                                    <button class="btn-secondary btn-small" onclick="app.allocateUnderspend(${i}, 'carry')">üì¶ Carry Forward</button>
                                    <button class="btn-success btn-small" onclick="app.allocateUnderspend(${i}, 'savings')">üíé Move to Savings</button>
                                </div>
                                <div id="allocation-${i}" style="margin-top: 12px; font-size: 13px; color: #10b981;"></div>
                            </div>
                        `).join('')}
                        <div style="margin-top: 24px; padding: 16px; background: #2a2a2a; border-radius: 12px; border: 1px solid #3a3a3a;">
                            <div id="allocationStatus" style="font-size: 16px; font-weight: 600; color: #ef4444;">
                                ‚ùå ${underspendData.length} envelope(s) need allocation
                            </div>
                        </div>
                        <button class="btn-success" id="finalizeBtn" style="width: 100%; margin-top: 20px; opacity: 0.5;" onclick="app.finalizeCloseMonth()" disabled>
                            Finalize & Close Month
                        </button>
                    `;
                }
                
                this.openModal('closeMonthModal');
            },
            
            allocateUnderspend(index, action) {
                const data = this.underspendData[index];
                
                if (action === 'carry') {
                    this.underspendAllocations[data.env.name] = { action: 'carry' };
                    document.getElementById(`allocation-${index}`).innerHTML = '<strong>‚úì Will carry forward</strong>';
                } else if (action === 'savings') {
                    const savingsEnvs = this.envelopeDefinitions.filter(e => e.type === 'savings');
                    
                    if (savingsEnvs.length === 0) {
                        alert('No savings envelopes available!');
                        return;
                    }
                    
                    const choice = prompt(`Move MVR ${data.underspend.toFixed(2)} to which savings?\n\n` +
                        savingsEnvs.map((e, i) => `${i + 1}. ${e.name} (${e.account})`).join('\n') +
                        `\n\nEnter number (1-${savingsEnvs.length}):`
                    );
                    
                    if (choice && choice >= 1 && choice <= savingsEnvs.length) {
                        const target = savingsEnvs[parseInt(choice) - 1];
                        this.underspendAllocations[data.env.name] = { action: 'savings', target: target.name };
                        document.getElementById(`allocation-${index}`).innerHTML = `<strong>‚úì Will move to ${target.name}</strong>`;
                    } else {
                        return;
                    }
                }
                
                const allocated = Object.keys(this.underspendAllocations).length;
                const total = this.underspendData.length;
                const statusDiv = document.getElementById('allocationStatus');
                const finalizeBtn = document.getElementById('finalizeBtn');
                
                if (allocated === total) {
                    statusDiv.innerHTML = '‚úÖ All underspend allocated! Ready to close.';
                    statusDiv.style.color = '#10b981';
                    finalizeBtn.disabled = false;
                    finalizeBtn.style.opacity = '1';
                } else {
                    statusDiv.innerHTML = `‚ùå ${total - allocated} envelope(s) still need allocation`;
                    statusDiv.style.color = '#ef4444';
                }
            },
            
            finalizeCloseMonth() {
                const monthKey = this.getMonthKey();
                
                if (this.underspendData && this.underspendData.length > 0) {
                    const allocated = Object.keys(this.underspendAllocations || {}).length;
                    if (allocated < this.underspendData.length) {
                        alert('Please allocate all underspend first!');
                        return;
                    }
                }
                
                if (this.underspendAllocations) {
                    Object.keys(this.underspendAllocations).forEach(envName => {
                        const allocation = this.underspendAllocations[envName];
                        const data = this.underspendData.find(d => d.env.name === envName);
                        
                        if (allocation.action === 'savings' && allocation.target) {
                            this.allTransactions.push({
                                type: 'transfer',
                                fromEnvelope: envName,
                                toEnvelope: allocation.target,
                                amount: data.underspend,
                                description: `End of month allocation - ${monthKey}`,
                                person: 'System',
                                date: new Date().toISOString()
                            });
                        }
                    });
                }
                
                if (!this.monthlyData[monthKey]) {
                    this.monthlyData[monthKey] = {};
                }
                this.monthlyData[monthKey].closed = true;
                
                this.saveToStorage();
                this.closeModal('closeMonthModal');
                this.render();
                
                alert(`‚úÖ Month ${monthKey} closed!`);
            },
            
            openComparison() {
                const closedMonths = Object.keys(this.monthlyData)
                    .filter(k => this.monthlyData[k].closed)
                    .sort()
                    .reverse()
                    .slice(0, 3);
                
                const content = document.getElementById('comparisonContent');
                
                if (closedMonths.length === 0) {
                    content.innerHTML = '<p style="text-align: center; color: #888888; padding: 40px;">No closed months yet.</p>';
                } else {
                    const comparisonData = closedMonths.map(mk => {
                        const transactions = this.getMonthTransactions(mk);
                        const allocated = transactions.filter(t => t.type === 'income').reduce((s, t) => s + t.amount, 0);
                        const spent = transactions.filter(t => t.type === 'expense').reduce((s, t) => s + t.amount, 0);
                        return { month: mk, allocated, spent, underspend: allocated - spent };
                    });
                    
                    content.innerHTML = `
                        <table style="width: 100%; border-collapse: collapse;">
                            <thead>
                                <tr style="border-bottom: 1px solid #2a2a2a;">
                                    <th style="padding: 12px; text-align: left; color: #888888;">Month</th>
                                    <th style="padding: 12px; text-align: left; color: #888888;">Allocated</th>
                                    <th style="padding: 12px; text-align: left; color: #888888;">Spent</th>
                                    <th style="padding: 12px; text-align: left; color: #888888;">Underspend</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${comparisonData.map(d => `
                                    <tr style="border-bottom: 1px solid #2a2a2a;">
                                        <td style="padding: 12px;"><strong>${d.month}</strong></td>
                                        <td style="padding: 12px;">MVR ${d.allocated.toFixed(2)}</td>
                                        <td style="padding: 12px;">MVR ${d.spent.toFixed(2)}</td>
                                        <td style="padding: 12px; color: ${d.underspend >= 0 ? '#10b981' : '#ef4444'};">MVR ${d.underspend.toFixed(2)}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    `;
                }
                
                this.openModal('comparisonModal');
            },
            
            openHowToUse() {
                this.openModal('howToUseModal');
            },
            
            viewAccountTransactions(accountName) {
                const content = document.getElementById('accountTransactionsContent');
                document.getElementById('accountTransactionsName').textContent = accountName;
                
                const accountEnvs = this.envelopeDefinitions.filter(e => e.account === accountName);
                const monthKey = this.getMonthKey();
                const monthTx = this.getMonthTransactions(monthKey).filter(t => 
                    accountEnvs.some(env => 
                        t.envelope === env.name || 
                        t.fromEnvelope === env.name || 
                        t.toEnvelope === env.name
                    )
                ).reverse();
                
                const accountBalances = this.getAccountBalances();
                const balances = this.getEnvelopeBalances();
                
                content.innerHTML = `
                    <div style="margin-bottom: 24px; padding: 20px; background: #2a2a2a; border-radius: 12px; border: 1px solid #3a3a3a;">
                        <div style="font-size: 13px; color: #888888; margin-bottom: 8px;">Total Balance</div>
                        <div style="font-size: 32px; font-weight: 700;">MVR ${accountBalances[accountName].toFixed(2)}</div>
                        <div style="font-size: 13px; color: #888888; margin-top: 4px;">Cumulative across all time</div>
                    </div>
                    
                    <h3 style="margin-bottom: 16px; font-size: 18px;">Envelopes in this Account</h3>
                    ${accountEnvs.map(env => `
                        <div style="padding: 12px; background: #2a2a2a; border-radius: 8px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center; border: 1px solid #3a3a3a;">
                            <div>
                                <div style="font-weight: 600;">${env.name}</div>
                                <div style="font-size: 13px; color: #888888;">${env.type}</div>
                            </div>
                            <div style="font-size: 18px; font-weight: 600;">MVR ${(balances[env.name] || 0).toFixed(2)}</div>
                        </div>
                    `).join('')}
                    
                    <h3 style="margin-top: 24px; margin-bottom: 16px; font-size: 18px;">This Month's Transactions</h3>
                    ${monthTx.length === 0 ? '<p style="text-align: center; color: #888888; padding: 40px;">No transactions</p>' : 
                        monthTx.map(t => {
                            const date = new Date(t.date);
                            const dateStr = date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                            let envText = t.envelope;
                            if (t.type === 'transfer') envText = `${t.fromEnvelope} ‚Üí ${t.toEnvelope}`;
                            
                            return `
                                <div class="transaction-item">
                                    <div class="transaction-info">
                                        <div class="transaction-envelope">${envText}</div>
                                        <div class="transaction-description">${t.description || ''}</div>
                                        <div class="transaction-meta">${t.person} ‚Ä¢ ${dateStr}</div>
                                    </div>
                                    <div class="transaction-amount ${t.type}">
                                        ${t.type === 'expense' ? '-' : t.type === 'income' ? '+' : ''}MVR ${t.amount.toFixed(2)}
                                    </div>
                                </div>
                            `;
                        }).join('')
                    }
                `;
                
                this.openModal('accountTransactionsModal');
            },
            
            viewEnvelopeDetail(index) {
                const env = this.envelopeDefinitions[index];
                const balances = this.getEnvelopeBalances();
                const balance = balances[env.name] || 0;
                const monthKey = this.getMonthKey();
                const monthTx = this.getMonthTransactions(monthKey).filter(t => 
                    t.envelope === env.name || t.fromEnvelope === env.name || t.toEnvelope === env.name
                ).reverse();
                
                document.getElementById('detailEnvelopeName').textContent = env.name;
                
                const content = document.getElementById('envelopeDetailContent');
                content.innerHTML = `
                    <div style="margin-bottom: 24px;">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px;">
                            <div>
                                <div style="font-size: 12px; color: #888888; margin-bottom: 4px;">Available Balance</div>
                                <div style="font-size: 32px; font-weight: 700; color: ${balance < 0 ? '#ef4444' : '#ffffff'};">MVR ${balance.toFixed(2)}</div>
                                <div style="font-size: 13px; color: #888888; margin-top: 4px;">Total across all time</div>
                            </div>
                            <div>
                                <div style="font-size: 12px; color: #888888; margin-bottom: 4px;">Account</div>
                                <div style="font-size: 18px; font-weight: 600; color: #0071e3;">${env.account}</div>
                                <button class="btn-secondary btn-small" onclick="app.changeEnvelopeAccount(${index})" style="margin-top: 8px;">Change Account</button>
                            </div>
                        </div>
                        <div style="padding: 16px; background: #2a2a2a; border-radius: 12px; border: 1px solid #3a3a3a; display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <div style="font-size: 13px; color: #888888;">Type</div>
                                <div style="font-size: 16px; font-weight: 600; margin-top: 4px;">
                                    ${env.type === 'savings' ? 'üíé Savings' : 'üîÑ Recurrent'}
                                </div>
                            </div>
                            <button class="btn-secondary btn-small" onclick="app.changeEnvelopeType(${index})">Change Type</button>
                        </div>
                    </div>
                    
                    <h3 style="margin-bottom: 16px; font-size: 18px;">This Month's Transactions</h3>
                    ${monthTx.length === 0 ? '<p style="text-align: center; color: #888888; padding: 40px;">No transactions</p>' : 
                        monthTx.map(t => {
                            const date = new Date(t.date);
                            const dateStr = date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                            
                            return `
                                <div class="transaction-item">
                                    <div class="transaction-info">
                                        <div class="transaction-description">${t.description || ''}</div>
                                        <div class="transaction-meta">${t.person} ‚Ä¢ ${dateStr}</div>
                                    </div>
                                    <div class="transaction-amount ${t.type}">
                                        ${t.type === 'expense' ? '-' : t.type === 'income' ? '+' : ''}MVR ${t.amount.toFixed(2)}
                                    </div>
                                </div>
                            `;
                        }).join('')
                    }
                `;
                
                this.openModal('envelopeDetailModal');
            },
            
            changeEnvelopeAccount(index) {
                const env = this.envelopeDefinitions[index];
                const choice = prompt(`Select account for "${env.name}":\n\n` +
                    this.accounts.map((a, i) => `${i + 1}. ${a}`).join('\n') +
                    `\n\nCurrent: ${env.account}\n\nEnter number (1-${this.accounts.length}):`
                );
                
                if (choice && choice >= 1 && choice <= this.accounts.length) {
                    env.account = this.accounts[parseInt(choice) - 1];
                    this.saveToStorage();
                    this.render();
                    this.closeModal('envelopeDetailModal');
                }
            },
            
            changeEnvelopeType(index) {
                const env = this.envelopeDefinitions[index];
                const newType = env.type === 'savings' ? 'recurrent' : 'savings';
                
                if (confirm(`Change "${env.name}" from ${env.type} to ${newType}?`)) {
                    env.type = newType;
                    this.saveToStorage();
                    this.render();
                    this.closeModal('manageEnvelopesModal');
                    this.closeModal('envelopeDetailModal');
                }
            },
            
            renameEnvelope(index) {
                const env = this.envelopeDefinitions[index];
                const newName = prompt(`Rename "${env.name}" to:`, env.name);
                
                if (!newName || newName.trim() === '') {
                    return;
                }
                
                const trimmedName = newName.trim();
                
                // Check if name already exists (excluding current envelope)
                if (this.envelopeDefinitions.some((e, i) => i !== index && e.name.toLowerCase() === trimmedName.toLowerCase())) {
                    alert('An envelope with this name already exists!');
                    return;
                }
                
                const oldName = env.name;
                env.name = trimmedName;
                
                // Update all transactions that reference this envelope
                this.allTransactions.forEach(t => {
                    if (t.envelope === oldName) t.envelope = trimmedName;
                    if (t.fromEnvelope === oldName) t.fromEnvelope = trimmedName;
                    if (t.toEnvelope === oldName) t.toEnvelope = trimmedName;
                });
                
                this.saveToStorage();
                this.render();
                this.openManageEnvelopes();
                alert(`‚úÖ Renamed "${oldName}" to "${trimmedName}"`);
            },
            
            renameAccount(index) {
                const oldName = this.accounts[index];
                const newName = prompt(`Rename account "${oldName}" to:`, oldName);
                
                if (!newName || newName.trim() === '') {
                    return;
                }
                
                const trimmedName = newName.trim();
                
                // Check if name already exists (excluding current account)
                if (this.accounts.some((a, i) => i !== index && a.toLowerCase() === trimmedName.toLowerCase())) {
                    alert('An account with this name already exists!');
                    return;
                }
                
                this.accounts[index] = trimmedName;
                
                // Update all envelopes that use this account
                this.envelopeDefinitions.forEach(env => {
                    if (env.account === oldName) {
                        env.account = trimmedName;
                    }
                });
                
                this.saveToStorage();
                this.render();
                this.openManageAccounts();
                alert(`‚úÖ Renamed account "${oldName}" to "${trimmedName}"`);
            },
            
            deleteEnvelope(index) {
                const env = this.envelopeDefinitions[index];
                
                if (!confirm(`Delete "${env.name}"? This cannot be undone.`)) {
                    return;
                }
                
                this.envelopeDefinitions.splice(index, 1);
                this.saveToStorage();
                this.render();
                this.openManageEnvelopes();
            },
            
            quickAddMoney(index) {
                if (this.isMonthClosed()) {
                    alert('Month is closed! Reopen it to make changes.');
                    return;
                }
                const env = this.envelopeDefinitions[index];
                document.getElementById('addEnvelope').value = env.name;
                this.openAddMoney();
            },
            
            quickExpense(index) {
                if (this.isMonthClosed()) {
                    alert('Month is closed! Reopen it to make changes.');
                    return;
                }
                const env = this.envelopeDefinitions[index];
                document.getElementById('expenseEnvelope').value = env.name;
                this.openRecordExpense();
            },
            
            switchTab(tab) {
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                
                // Find the clicked tab button and activate it
                const clickedButton = event ? event.target : document.querySelector('.tab');
                clickedButton.classList.add('active');
                
                // Show the corresponding content
                document.getElementById(tab + 'Tab').classList.add('active');
                
                // Refresh transactions when switching to transactions tab
                if (tab === 'transactions') {
                    this.renderTransactions();
                }
            },
            
            populateDropdowns() {
                const envOptions = this.envelopeDefinitions.map(e => 
                    `<option value="${e.name}">${e.name}</option>`
                ).join('');
                
                ['addEnvelope', 'expenseEnvelope', 'transferFrom', 'transferTo'].forEach(id => {
                    const el = document.getElementById(id);
                    if (el) el.innerHTML = envOptions;
                });
                
                const accountOptions = this.accounts.map(a => 
                    `<option value="${a}">${a}</option>`
                ).join('');
                
                const accountSelect = document.getElementById('newEnvelopeAccount');
                if (accountSelect) {
                    accountSelect.innerHTML = accountOptions;
                }
            },
            
            // Form handlers
            setupEventListeners() {
                document.getElementById('addMoneyForm').addEventListener('submit', (e) => {
                    e.preventDefault();
                    
                    const envelope = document.getElementById('addEnvelope').value;
                    const amount = parseFloat(document.getElementById('addAmount').value);
                    const description = document.getElementById('addDescription').value;
                    const person = document.getElementById('addPerson').value;
                    
                    const monthYear = this.currentViewMonth.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
                    const fullDesc = description ? `${monthYear} - ${description}` : monthYear;
                    
                    this.allTransactions.push({
                        type: 'income',
                        envelope: envelope,
                        amount: amount,
                        description: fullDesc,
                        person: person,
                        date: new Date(this.currentViewMonth.getFullYear(), this.currentViewMonth.getMonth(), new Date().getDate()).toISOString()
                    });
                    
                    this.saveToStorage();
                    this.closeModal('addMoneyModal');
                    e.target.reset();
                    this.render();
                });
                
                document.getElementById('expenseForm').addEventListener('submit', (e) => {
                    e.preventDefault();
                    
                    const envelope = document.getElementById('expenseEnvelope').value;
                    const amount = parseFloat(document.getElementById('expenseAmount').value);
                    const description = document.getElementById('expenseDescription').value;
                    const person = document.getElementById('expensePerson').value;
                    
                    this.allTransactions.push({
                        type: 'expense',
                        envelope: envelope,
                        amount: amount,
                        description: description,
                        person: person,
                        date: new Date().toISOString()
                    });
                    
                    this.saveToStorage();
                    this.closeModal('expenseModal');
                    e.target.reset();
                    this.render();
                });
                
                document.getElementById('transferForm').addEventListener('submit', (e) => {
                    e.preventDefault();
                    
                    const from = document.getElementById('transferFrom').value;
                    const to = document.getElementById('transferTo').value;
                    const amount = parseFloat(document.getElementById('transferAmount').value);
                    const note = document.getElementById('transferNote').value;
                    const person = document.getElementById('transferPerson').value;
                    
                    if (from === to) {
                        alert('Cannot transfer to same envelope!');
                        return;
                    }
                    
                    this.allTransactions.push({
                        type: 'transfer',
                        fromEnvelope: from,
                        toEnvelope: to,
                        amount: amount,
                        description: note || 'Transfer',
                        person: person,
                        date: new Date().toISOString()
                    });
                    
                    this.saveToStorage();
                    this.closeModal('transferModal');
                    e.target.reset();
                    this.render();
                });
                
                document.getElementById('addEnvelopeForm').addEventListener('submit', (e) => {
                    e.preventDefault();
                    
                    const name = document.getElementById('newEnvelopeName').value;
                    const type = document.getElementById('newEnvelopeType').value;
                    const account = document.getElementById('newEnvelopeAccount').value;
                    
                    if (this.envelopeDefinitions.find(e => e.name.toLowerCase() === name.toLowerCase())) {
                        alert('Envelope with this name already exists!');
                        return;
                    }
                    
                    this.envelopeDefinitions.push({ name, type, account });
                    
                    this.saveToStorage();
                    this.closeModal('addEnvelopeModal');
                    e.target.reset();
                    this.render();
                    alert(`Envelope "${name}" created!`);
                });
                
                document.getElementById('addAccountForm').addEventListener('submit', (e) => {
                    e.preventDefault();
                    
                    const name = document.getElementById('newAccountName').value;
                    
                    if (this.accounts.find(a => a.toLowerCase() === name.toLowerCase())) {
                        alert('Account with this name already exists!');
                        return;
                    }
                    
                    this.accounts.push(name);
                    
                    this.saveToStorage();
                    this.closeModal('addAccountModal');
                    e.target.reset();
                    this.render();
                    alert(`Account "${name}" created!`);
                });
                
                // Close modals and dropdowns on outside click
                document.querySelectorAll('.modal').forEach(modal => {
                    modal.addEventListener('click', (e) => {
                        if (e.target === modal) {
                            modal.classList.remove('active');
                        }
                    });
                });
                
                document.addEventListener('click', (e) => {
                    const dropdown = document.getElementById('settingsDropdown');
                    const toggle = e.target.closest('.dropdown-toggle');
                    if (!toggle && !e.target.closest('.dropdown-menu')) {
                        dropdown.classList.remove('active');
                    }
                });
            }
        };

        // Initialize app
        document.addEventListener('DOMContentLoaded', () => {
            app.init();
            console.log('‚úÖ Envelope Budget Manager initialized');
            console.log('üì¶ Data structure ready for Firebase');
        });
    </script>
</body>
</html>
